// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String
  password         String
  subscriptionTier String   @default("free") @map("subscription_tier")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  profile          UserProfile?
  sessions         InterviewSession[]
  practiceSessions PracticeSession[]

  @@map("users")
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique @map("user_id")
  seniority   String?
  industries  Json?
  skills      Json?
  experience  Json?
  preferences Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model InterviewSession {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  jobContext Json?     @map("job_context")
  status     String    @default("active")
  settings   Json?
  startedAt  DateTime  @default(now()) @map("started_at")
  endedAt    DateTime? @map("ended_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  interactions         Interaction[]
  metrics              SessionMetrics[]
  transcriptionResults TranscriptionResult[]
  audioChunks          AudioChunk[]

  @@map("interview_sessions")
}

model Interaction {
  id                     String   @id @default(cuid())
  sessionId              String   @map("session_id")
  question               String
  questionClassification Json?    @map("question_classification")
  generatedResponses     Json?    @map("generated_responses")
  selectedResponse       String?  @map("selected_response")
  userFeedback          Int?     @map("user_feedback")
  timestamp              DateTime @default(now())

  session              InterviewSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  transcriptionResults TranscriptionResult[]

  @@map("interactions")
}

model SessionMetrics {
  id                      String   @id @default(cuid())
  sessionId               String   @map("session_id")
  transcriptionLatencyMs  Int?     @map("transcription_latency_ms")
  responseGenerationMs    Int?     @map("response_generation_ms")
  totalLatencyMs          Int?     @map("total_latency_ms")
  transcriptionAccuracy   Decimal? @map("transcription_accuracy") @db.Decimal(5, 2)
  userSatisfaction        Int?     @map("user_satisfaction")
  createdAt               DateTime @default(now()) @map("created_at")

  session InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("session_metrics")
}

model TranscriptionResult {
  id                String   @id @default(cuid())
  sessionId         String   @map("session_id")
  interactionId     String?  @map("interaction_id")
  audioChunkId      String   @map("audio_chunk_id")
  text              String
  confidence        Decimal  @db.Decimal(5, 4)
  isFinal           Boolean  @default(false) @map("is_final")
  provider          String   // 'google' | 'whisper'
  language          String   @default("en-US")
  speakerId         String?  @map("speaker_id")
  startTime         Decimal? @map("start_time") @db.Decimal(10, 3)
  endTime           Decimal? @map("end_time") @db.Decimal(10, 3)
  alternatives      Json?    // Alternative transcriptions
  metadata          Json?    // Additional provider-specific data
  createdAt         DateTime @default(now()) @map("created_at")

  session     InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  interaction Interaction?     @relation(fields: [interactionId], references: [id], onDelete: SetNull)

  @@index([sessionId, createdAt])
  @@index([audioChunkId])
  @@map("transcription_results")
}

model AudioChunk {
  id            String   @id @default(cuid())
  sessionId     String   @map("session_id")
  chunkIndex    Int      @map("chunk_index")
  audioData     Bytes?   @map("audio_data") // Store small chunks temporarily
  audioUrl      String?  @map("audio_url")  // URL for larger files
  format        String   @default("webm")
  sampleRate    Int      @default(16000) @map("sample_rate")
  channels      Int      @default(1)
  duration      Decimal? @db.Decimal(10, 3)
  size          Int?     // Size in bytes
  checksum      String?  // For integrity verification
  processedAt   DateTime? @map("processed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  session InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, chunkIndex])
  @@map("audio_chunks")
}

model TranscriptionCache {
  id          String   @id @default(cuid())
  audioHash   String   @unique @map("audio_hash") // Hash of audio content
  text        String
  confidence  Decimal  @db.Decimal(5, 4)
  provider    String
  language    String   @default("en-US")
  metadata    Json?
  hitCount    Int      @default(1) @map("hit_count")
  lastUsed    DateTime @default(now()) @map("last_used")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([audioHash])
  @@index([lastUsed])
  @@map("transcription_cache")
}

model PracticeSession {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  jobTitle        String    @map("job_title")
  industry        String
  difficulty      String    // 'junior' | 'mid' | 'senior'
  questionTypes   Json      @map("question_types") // Array of question types
  questionCount   Int       @map("question_count")
  status          String    @default("active") // 'active' | 'completed' | 'abandoned'
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  duration        Int?      // Duration in minutes
  averageScore    Decimal?  @map("average_score") @db.Decimal(4, 2)
  createdAt       DateTime  @default(now()) @map("created_at")

  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions         PracticeQuestion[]
  responses         PracticeResponse[]
  analytics         PracticeAnalytics[]

  @@index([userId, createdAt])
  @@map("practice_sessions")
}

model QuestionBank {
  id              String   @id @default(cuid())
  question        String
  type            String   // 'technical' | 'behavioral' | 'situational' | 'cultural'
  category        String
  industry        String
  difficulty      String   // 'junior' | 'mid' | 'senior'
  expectedStructure String? @map("expected_structure")
  keyPoints       Json?    @map("key_points") // Array of key points
  timeLimit       Int?     @map("time_limit") // Time limit in seconds
  tags            Json?    // Array of tags
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  practiceQuestions PracticeQuestion[]

  @@index([type, industry, difficulty])
  @@index([category, isActive])
  @@map("question_bank")
}

model PracticeQuestion {
  id              String   @id @default(cuid())
  sessionId       String   @map("session_id")
  questionBankId  String   @map("question_bank_id")
  questionOrder   Int      @map("question_order")
  presentedAt     DateTime @default(now()) @map("presented_at")
  answeredAt      DateTime? @map("answered_at")

  session       PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questionBank  QuestionBank    @relation(fields: [questionBankId], references: [id])
  response      PracticeResponse?

  @@index([sessionId, questionOrder])
  @@map("practice_questions")
}

model PracticeResponse {
  id                  String   @id @default(cuid())
  sessionId           String   @map("session_id")
  questionId          String   @unique @map("question_id")
  response            String
  duration            Int      // Duration in seconds
  usedAISuggestions   Boolean  @default(false) @map("used_ai_suggestions")
  overallScore        Decimal? @map("overall_score") @db.Decimal(4, 2)
  contentScore        Decimal? @map("content_score") @db.Decimal(4, 2)
  structureScore      Decimal? @map("structure_score") @db.Decimal(4, 2)
  clarityScore        Decimal? @map("clarity_score") @db.Decimal(4, 2)
  feedback            String?
  strengths           Json?    // Array of strengths
  improvements        Json?    // Array of improvements
  suggestions         Json?    // Array of suggestions
  createdAt           DateTime @default(now()) @map("created_at")

  session   PracticeSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question  PracticeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("practice_responses")
}

model PracticeAnalytics {
  id                    String   @id @default(cuid())
  sessionId             String   @map("session_id")
  userId                String   @map("user_id")
  totalQuestions        Int      @map("total_questions")
  questionsAnswered     Int      @map("questions_answered")
  averageResponseTime   Int?     @map("average_response_time") // In seconds
  averageScore          Decimal? @map("average_score") @db.Decimal(4, 2)
  strongestAreas        Json?    @map("strongest_areas") // Array of areas
  improvementAreas      Json?    @map("improvement_areas") // Array of areas
  progressMetrics       Json?    @map("progress_metrics") // Custom metrics
  createdAt             DateTime @default(now()) @map("created_at")

  session PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("practice_analytics")
}